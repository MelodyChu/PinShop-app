{% extends 'base.html' %}
{% block content %}

    <h1>PinShop Results</h1>
  <div>
  <h3>Sort by:</h3>
  <input type="radio" name="result-sort" class="sortradiobutton" id="popularity" value="popularity" checked>
  <label for="popularity">Popularity

  <input type="radio" name="result-sort" class="sortradiobutton" id="lowtohigh" value="lowtohigh">
  <label for="lowtohigh">Price: Low to High

  <input type="radio" name="result-sort" class="sortradiobutton" id="hightolow" value="hightolow">
  <label for="hightolow">Price: High to Low
  
  <input type="radio" name="result-sort" class="sortradiobutton" id="sortbrand" value="sortbrand">
  <label for="sortbrand">Specific Brand
   <select name="brand-dropdown" id="brand-dropdown">
    {% for brand in brand_set %}
      <option class="brand-select" value="{{ brand }}">{{ brand }}</option>
    {% endfor %}
  </select>
  </div>

    <div class="product-list">
    {% for i, result in enumerate(results) %}
      <div class="list-item" id="{{ result['id'] }}" data-price="{{ result['price'] }}" data-popularity="{{ i }}" data-brand="{{ result['brand'] }}" >
        <a class="product-info" href="{{ result['url'] }}"><img src="{{ result['image_url'] }}" class="result_image">{{ result['name'] }}
        <div>{{ result['priceLabel'] }}</div></a>
        {% if "user_id" in session %}
            <button class="save-button" data-listingdata="{{ result['id'] }}" >Save</button>
        {% endif %}
      </div>
    {% endfor %}
    </div>
 


    
    <script> // try document ready & load the jquery tag in the head
    ( function () {

    $('.sortradiobutton').click(function (evt) {
        let sortingMethod = $(this).val(); // check which value of sorting method is selected
        console.log(sortingMethod);

        if (sortingMethod == "lowtohigh")
        {
          sortAscending("price");
        }
        else if (sortingMethod == "hightolow")
        {
          sortDescending("price");
        }
        else if (sortingMethod == "popularity") 
        {
          sortAscending("popularity");
        }
        else if (sortingMethod == "sortbrand")
        {
          sortbyBrand("brand")
        }

    });

    function sortAscending(sortparam)
    {
      let products = $('.list-item');
      products.show();
      products.sort(function(a, b) {
        return $(a).data(sortparam)-$(b).data(sortparam)});
        $(".product-list").html(products);
        console.log("used sortProductsPriceAscending");

      }

    function sortDescending(sortparam)
    {
      let products = $('.list-item');
      products.show();
      products.sort(function(a, b) {
        return $(b).data(sortparam)-$(a).data(sortparam)});
        $(".product-list").html(products);
        console.log("used sortProductsPriceDescending");

      }

    function sortbyBrand(sortparam)
    {
      let products = $('.list-item');
      let selectedBrand = $('#brand-dropdown').find(":selected").text();
      
      let filtered = products.filter(function(idx, element) {
        console.log($(element).data(sortparam) != selectedBrand)
        return ($(element).data(sortparam) != selectedBrand)
      }).hide();

      console.log(filtered)

    }

    
    $('.save-button').click(function (evt) {
        let listingdata = $(this).data("listingdata"); // may need JSON dumps here
        // $(this).html("saved");
        // Given an id on a save-button
        

        let payload = {"listing_data": listingdata} // does passing data always need to be in payload dictionary format?
        // console.log(payload);
        console.log(listingdata); 
        console.log(typeof(listingdata));
        $.get('/get-item-info', payload, get_item_info);

        function get_item_info (response) {
          console.log(response);

          $.ajax({
            url: "/add-bookmark.json", 
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(response),
            processData: false,
            success: function display_saved(results) { // would payload = requests in this case?
            //give user some visual indication that this has happened
            // $(this).html("Saved"); // need to debug; not working
            //console.log(results);
            console.log("Finished saving ShopStyle API result!");

            }
          });
          // THIS WORKED
          // $('.save-button').html("saved");
          // $(this).html("saved");
        };
        $(this).html("Saved");
})

})
();

</script>

{% endblock %}